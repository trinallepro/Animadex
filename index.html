<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Animadex </title>
  <!-- Reference the web manifest -->
  <link rel="manifest" crossorigin="use-credentials" href="/manifest.json" />
  <!-- Add-to-Homescreen library CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/philfung/add-to-homescreen@3.4/dist/add-to-homescreen.min.css" />
  <!-- Add-to-Homescreen library JavaScript (French locale) -->
  <script src="https://cdn.jsdelivr.net/gh/philfung/add-to-homescreen@3.4/dist/add-to-homescreen_fr.min.js"></script>
  <!-- Existing dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@latest"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    /* Existing styles unchanged */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 25%, #e0f2e0 50%, #f5f9f5 75%, #e8f5e8 100%);
      min-height: 100vh;
      padding: 20px;
      color: #2d5016;
      position: relative;
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at 20% 30%, rgba(144, 238, 144, 0.1) 0%, transparent 50%),
      radial-gradient(circle at 80% 70%, rgba(152, 251, 152, 0.08) 0%, transparent 50%),
      radial-gradient(circle at 60% 20%, rgba(173, 255, 173, 0.06) 0%, transparent 50%);
      pointer-events: none;
      z-index: -1;
    }

    h1 {
      text-align: center;
      color: #2d5016;
      font-weight: 600;
      font-size: 3em;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(240, 248, 240, 0.9));
      padding: 25px;
      border-radius: 25px;
      margin-bottom: 30px;
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 30px rgba(45, 80, 22, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.8);
      border: 1px solid rgba(144, 238, 144, 0.3);
      animation: fadeInDown 1s ease-out;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    h1 i {
      font-size: 1.2em;
      color: #90ee90;
    }

    .upload-section {
      background: linear-gradient(145deg, rgba(255, 255, 255, 0.95), rgba(240, 248, 240, 0.9));
      padding: 35px;
      border-radius: 25px;
      margin: 0 auto 40px;
      max-width: 650px;
      text-align: center;
      box-shadow: 0 15px 35px rgba(45, 80, 22, 0.08), inset 0 1px 0 rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(144, 238, 144, 0.2);
      backdrop-filter: blur(15px);
      animation: fadeInUp 1s ease-out 0.3s both;
      transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }

    .upload-section:hover {
      transform: translateY(-5px);
      box-shadow: 0 25px 45px rgba(45, 80, 22, 0.12), inset 0 1px 0 rgba(255, 255, 255, 0.9);
    }

    .upload-section h2 {
      color: #2d5016;
      margin-bottom: 15px;
      font-weight: 500;
      font-size: 1.8em;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .upload-section h2 i {
      color: #90ee90;
    }

    .upload-section p {
      color: #4a6b2a;
      margin-bottom: 25px;
      font-size: 1.1em;
      font-weight: 300;
    }

    input[type="file"], input[type="text"] {
      margin: 12px;
      padding: 15px 20px;
      border-radius: 15px;
      border: 2px solid rgba(144, 238, 144, 0.3);
      background: rgba(255, 255, 255, 0.9);
      width: 85%;
      font-size: 1em;
      color: #2d5016;
      transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      backdrop-filter: blur(5px);
    }

    input[type="file"]:focus, input[type="text"]:focus {
      outline: none;
      border-color: #90ee90;
      box-shadow: 0 0 0 4px rgba(144, 238, 144, 0.1);
      transform: translateY(-2px);
    }

    button {
      background: linear-gradient(135deg, #90ee90, #7dd87d);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 15px;
      cursor: pointer;
      font-size: 1.1em;
      margin: 8px;
      font-weight: 500;
      transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      box-shadow: 0 8px 20px rgba(125, 216, 125, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.2);
      position: relative;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    button i {
      font-size: 1.1em;
    }

    button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    button:hover {
      background: linear-gradient(135deg, #7dd87d, #6bc96b);
      transform: translateY(-3px);
      box-shadow: 0 12px 25px rgba(125, 216, 125, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.4);
    }

    button:hover::before {
      left: 100%;
    }

    button:active {
      transform: translateY(-1px);
    }

    button:disabled {
      background: linear-gradient(135deg, #c8e6c9, #b8d8b9);
      cursor: not-allowed;
      transform: none;
      box-shadow: 0 4px 10px rgba(184, 216, 185, 0.2);
    }

    .loading {
      color: #4a6b2a;
      font-style: italic;
      font-weight: 300;
      animation: pulse 2s infinite;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .loading i {
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes pulse {
      0%, 100% { opacity: 0.7; }
      50% { opacity: 1; }
    }

    #cameraPreview {
      width: 100%;
      max-width: 400px;
      margin: 15px auto;
      display: none;
      border: 3px solid rgba(144, 238, 144, 0.4);
      border-radius: 20px;
      box-shadow: 0 10px 25px rgba(45, 80, 22, 0.1);
      transition: all 0.3s ease;
    }

    .dex-container {
      animation: fadeIn 1s ease-out 0.6s both;
    }

    .dex-container h2 {
      text-align: center;
      color: #2d5016;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(240, 248, 240, 0.9));
      padding: 20px;
      border-radius: 20px;
      margin-bottom: 25px;
      font-weight: 500;
      font-size: 1.8em;
      box-shadow: 0 8px 20px rgba(45, 80, 22, 0.08), inset 0 1px 0 rgba(255, 255, 255, 0.8);
      border: 1px solid rgba(144, 238, 144, 0.2);
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .dex-container h2 i {
      color: #90ee90;
    }

    .dex-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 25px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .animal-card {
      background: linear-gradient(145deg, rgba(255, 255, 255, 0.95), rgba(248, 252, 248, 0.9));
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(45, 80, 22, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.9);
      transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      animation: growIn 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      border: 1px solid rgba(144, 238, 144, 0.2);
      backdrop-filter: blur(10px);
      position: relative;
      overflow: hidden;
    }

    .animal-card.new {
      animation: popIn 0.6s ease-out;
    }

    @keyframes popIn {
      0% { opacity: 0; transform: scale(0.5) rotate(-10deg); }
      70% { transform: scale(1.1) rotate(5deg); }
      100% { opacity: 1; transform: scale(1) rotate(0); }
    }

    .animal-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 3px;
      background: linear-gradient(90deg, #90ee90, #7dd87d, #98fb98);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .animal-card:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow: 0 20px 40px rgba(45, 80, 22, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.9);
    }

    .animal-card:hover::before {
      opacity: 1;
    }

    .animal-card img {
      width: 100%;
      height: 220px;
      object-fit: cover;
      transition: all 0.4s ease;
      filter: saturate(0.9) brightness(1.1);
    }

    .animal-card:hover img {
      filter: saturate(1.1) brightness(1.2);
      transform: scale(1.05) rotate(2deg);
    }

    .animal-info {
      padding: 20px;
      text-align: center;
    }

    .animal-name {
      font-weight: 600;
      color: #2d5016;
      margin-bottom: 8px;
      font-size: 1.4em;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .animal-name i {
      color: #90ee90;
      font-size: 1.2em;
    }

    .confidence {
      font-size: 0.95em;
      color: #4a6b2a;
      margin-bottom: 10px;
      font-weight: 300;
    }

    .type {
      background: linear-gradient(135deg, #90ee90, #7dd87d);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.9em;
      display: inline-block;
      margin: 8px 0;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(125, 216, 125, 0.3);
    }

    .delete-btn {
      background: linear-gradient(135deg, #ffab91, #ff8a65);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 12px;
      cursor: pointer;
      margin-top: 15px;
      font-size: 0.9em;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(255, 138, 101, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .delete-btn i {
      font-size: 1em;
    }

    .delete-btn:hover {
      background: linear-gradient(135deg, #ff8a65, #ff7043);
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(255, 138, 101, 0.4);
    }

    .clear-btn {
      background: linear-gradient(135deg, #ce93d8, #ba68c8);
      box-shadow: 0 6px 15px rgba(186, 104, 200, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .clear-btn i {
      font-size: 1.1em;
    }

    .clear-btn:hover {
      background: linear-gradient(135deg, #ba68c8, #ab47bc);
      box-shadow: 0 8px 20px rgba(186, 104, 200, 0.4);
    }

    /* Tutorial Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
      animation: fadeIn 0.5s;
    }

    .modal-content {
      background: linear-gradient(145deg, rgba(255, 255, 255, 0.98), rgba(240, 248, 240, 0.95));
      margin: 15% auto;
      padding: 30px;
      border-radius: 25px;
      max-width: 600px;
      box-shadow: 0 15px 35px rgba(45, 80, 22, 0.15);
      border: 1px solid rgba(144, 238, 144, 0.3);
      backdrop-filter: blur(15px);
      position: relative;
      animation: slideIn 0.5s ease-out;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-50px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .close {
      position: absolute;
      right: 20px;
      top: 15px;
      color: #4a6b2a;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      transition: color 0.3s;
    }

    .close:hover {
      color: #2d5016;
    }

    .tutorial-step {
      margin-bottom: 20px;
      font-size: 1.1em;
      color: #4a6b2a;
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }

    .tutorial-step i {
      color: #90ee90;
      font-size: 1.5em;
      margin-top: 2px;
    }

    .tutorial-step strong {
      color: #2d5016;
    }

    #tutorialBtn {
      background: linear-gradient(135deg, #64b5f6, #42a5f5);
      box-shadow: 0 6px 15px rgba(66, 165, 245, 0.3);
      margin: 0 auto 20px;
      display: block;
      width: fit-content;
    }

    #tutorialBtn:hover {
      background: linear-gradient(135deg, #42a5f5, #2196f3);
    }

    #installBtn {
      background: linear-gradient(135deg, #ffd54f, #ffca28);
      box-shadow: 0 6px 15px rgba(255, 202, 40, 0.3);
      margin: 0 auto 20px;
      display: block;
      width: fit-content;
    }

    #installBtn:hover {
      background: linear-gradient(135deg, #ffca28, #ffb300);
      box-shadow: 0 8px 20px rgba(255, 202, 40, 0.4);
    }

    @keyframes fadeInDown {
      from { opacity: 0; transform: translateY(-30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes growIn {
      from { opacity: 0; transform: scale(0.9) translateY(20px); }
      to { opacity: 1; transform: scale(1) translateY(0); }
    }

    /* Scrollbar personnalisée */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(240, 248, 240, 0.5);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, #90ee90, #7dd87d);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(135deg, #7dd87d, #6bc96b);
    }

    /* Responsive Improvements */
    @media (max-width: 768px) {
      h1 {
        font-size: 2.2em;
        padding: 15px;
      }

      .upload-section {
        padding: 25px 15px;
        margin: 0 5px 30px;
        max-width: 100%;
      }

      input[type="file"], input[type="text"] {
        width: 95%;
        font-size: 0.95em;
      }

      button {
        padding: 12px 25px;
        font-size: 1em;
      }

      .dex-grid {
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
        margin: 0 5px;
      }

      .animal-card img {
        height: 180px;
      }

      .animal-name {
        font-size: 1.2em;
      }

      .modal-content {
        margin: 20% auto;
        padding: 20px;
        max-width: 90%;
      }

      .tutorial-step {
        font-size: 1em;
      }
    }

    @media (max-width: 480px) {
      h1 {
        font-size: 1.8em;
      }

      .upload-section h2 {
        font-size: 1.5em;
      }

      .dex-container h2 {
        font-size: 1.5em;
      }

      .animal-card {
        font-size: 0.9em;
      }
    }
  </style>
</head>
<body>
<h1><i class="fas fa-book"></i> Animadex</h1>

<div class="upload-section">
  <h2><i class="fas fa-camera-retro"></i> Capturez un Animal</h2>
  <p>L'IA identifie l'espèce</p>
  <input type="file" id="animalPhoto" accept="image/*" aria-label="Télécharger une photo d'animal">
  <button id="cameraBtn" onclick="startCamera()" aria-label="Ouvrir la caméra"><i class="fas fa-video"></i> Capturer avec Caméra</button>
  <video id="cameraPreview" autoplay playsinline aria-label="Aperçu de la caméra"></video>
  <button id="captureBtn" onclick="capturePhoto()" style="display: none;" aria-label="Prendre une photo"><i class="fas fa-camera"></i> Prendre Photo</button>
  <input type="text" id="animalName" placeholder="Mettez le nom de l'animal si vous le connaissez" aria-label="Nom de l'espèce détectée">
  <button id="addBtn" onclick="addAnimal()" disabled aria-label="Analyser et ajouter l'animal"><i class="fas fa-search"></i> Analyser et Capturer !</button>
  <p id="status" class="loading" style="display: none;"><i class="fas fa-spinner"></i> IA en train d'explorer...</p>
</div>

<div id="dexContainer" class="dex-container">
  <h2><i class="fas fa-book"></i> Votre Animadex</h2>
  <button id="installBtn" onclick="showInstallPrompt()" aria-label="Installer Animadex"><i class="fas fa-download"></i> Installer Animadex</button>
  <button id="tutorialBtn" onclick="showTutorial()" aria-label="Afficher le tutoriel"><i class="fas fa-question-circle"></i> Tutoriel</button>
  <button class="clear-btn" onclick="clearDex()" style="display: block; margin: 0 auto 30px;" aria-label="Vider le Dex"><i class="fas fa-trash-alt"></i> Vider le Dex</button>
  <div class="dex-grid" id="dexGrid"></div>
</div>

<!-- Tutorial Modal -->
<div id="tutorialModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeTutorial()" aria-label="Fermer le tutoriel">&times;</span>
    <h2 style="text-align: center; color: #2d5016; margin-bottom: 20px;"><i class="fas fa-question-circle"></i> Tutoriel Animadex</h2>
    <div class="tutorial-step"><i class="fas fa-camera"></i><span><strong>Étape 1:</strong> Sélectionnez une photo d'animal depuis votre appareil ou utilisez la caméra pour en capturer une.</span></div>
    <div class="tutorial-step"><i class="fas fa-search"></i><span><strong>Étape 2:</strong> Cliquez sur "Analyser et Capturer !" L'IA trouvera l'espèce.</span></div>
    <div class="tutorial-step"><i class="fas fa-book"></i><span><strong>Étape 3:</strong> L'animal s'ajoute à votre Animadex.</span></div>
    <div class="tutorial-step"><i class="fas fa-save"></i><span><strong>Stockage:</strong> Vos entrées sont sauvegardées dans votre navigateur.</span></div>
    <div class="tutorial-step"><i class="fas fa-download"></i><span><strong>Installation:</strong> Cliquez sur "Installer Animadex" pour ajouter l'application à votre écran d'accueil.</span></div>
  </div>
</div>

<canvas id="canvas" style="display: none;"></canvas>

<script>
  // Initialize Add-to-Homescreen library
  document.addEventListener('DOMContentLoaded', function () {
    window.AddToHomeScreenInstance = window.AddToHomeScreen({
      appName: 'Animadex',
      appNameDisplay: 'standalone',
      appIconUrl: '/icon.png',
      assetUrl: 'https://cdn.jsdelivr.net/gh/philfung/add-to-homescreen@3.4/dist/assets/img/',
      maxModalDisplayCount: -1,
      displayOptions: { showMobile: true, showDesktop: true },
      allowClose: true,
      showArrow: true
    });

    // Show prompt automatically on first visit (if not installed)
    if (!localStorage.getItem('animadexInstalled')) {
      window.AddToHomeScreenInstance.show('fr');
      localStorage.setItem('animadexInstalled', 'true');
    }
  });

  // Function to show install prompt manually
  function showInstallPrompt() {
    window.AddToHomeScreenInstance.show('fr');
  }

  let animalDex = [];
  let model;
  let video = document.getElementById('cameraPreview');
  let canvas = document.getElementById('canvas');
  let stream;
  const addBtn = document.getElementById('addBtn');
  const captureBtn = document.getElementById('captureBtn');
  const nameInput = document.getElementById('animalName');
  const status = document.getElementById('status');
  const photoInput = document.getElementById('animalPhoto');
  const tutorialModal = document.getElementById('tutorialModal');

  // Table de traduction anglais -> français (étendue pour plus d'animaux)
  const translations = {
    'dog': 'Chien', 'cat': 'Chat', 'horse': 'Cheval', 'cow': 'Vache',
    'elephant': 'Éléphant', 'bear': 'Ours', 'zebra': 'Zèbre', 'giraffe': 'Girafe',
    'sheep': 'Mouton', 'tiger': 'Tigre', 'lion': 'Lion', 'wolf': 'Loup',
    'fox': 'Renard', 'deer': 'Cerf', 'rabbit': 'Lapin', 'monkey': 'Singe',
    'bird': 'Oiseau', 'parrot': 'Perroquet', 'eagle': 'Aigle', 'owl': 'Chouette',
    'fish': 'Poisson', 'shark': 'Requin', 'turtle': 'Tortue', 'snake': 'Serpent',
    'crocodile': 'Crocodile', 'insect': 'Insecte', 'butterfly': 'Papillon',
    'spider': 'Araignée', 'panda': 'Panda', 'kangaroo': 'Kangourou',
    'dolphin': 'Dauphin', 'whale': 'Baleine', 'penguin': 'Pingouin',
    'frog': 'Grenouille', 'lizard': 'Lézard', 'bat': 'Chauve-souris', 'squirrel': 'Écureuil'
  };

  // Chargement du modèle MobileNet
  async function loadModel() {
    try {
      model = await mobilenet.load();
      addBtn.disabled = false;
      console.log('Modèle MobileNet chargé !');
      checkFirstVisit();
    } catch (error) {
      console.error('Erreur lors du chargement du modèle:', error);
      alert('Erreur lors du chargement de l\'IA. Vérifiez votre connexion internet.');
    }
  }

  // Vérifier si c'est la première visite pour afficher le tuto
  function checkFirstVisit() {
    try {
      if (!localStorage.getItem('animadexVisited')) {
        showTutorial();
        localStorage.setItem('animadexVisited', 'true');
      }
    } catch (error) {
      console.error('Erreur avec localStorage:', error);
      showTutorial(); // Afficher le tuto même si localStorage échoue
    }
  }

  // Afficher le modal tuto
  function showTutorial() {
    tutorialModal.style.display = 'block';
  }

  // Fermer le modal tuto
  function closeTutorial() {
    tutorialModal.style.display = 'none';
  }

  // Fermer modal si clic en dehors
  window.onclick = function(event) {
    if (event.target == tutorialModal) {
      closeTutorial();
    }
  }

  // Démarrer la caméra
  async function startCamera() {
    try {
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: 'environment' } } });
      video.srcObject = stream;
      video.style.display = 'block';
      captureBtn.style.display = 'inline-block';
    } catch (error) {
      console.error('Erreur caméra:', error);
      alert('Impossible d\'accéder à la caméra. Vérifiez les permissions ou essayez un autre appareil.');
    }
  }

  // Capturer photo depuis caméra
  function capturePhoto() {
    if (!video.videoWidth || !video.videoHeight) {
      alert('La caméra n\'est pas prête. Réessayez.');
      return;
    }
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video, 0, 0);
    const imageData = canvas.toDataURL('image/png');
    processImage(imageData);
    stopCamera();
  }

  // Arrêter la caméra
  function stopCamera() {
    if (stream) {
      stream.getTracks().forEach(track => track.stop());
      stream = null;
    }
    video.style.display = 'none';
    captureBtn.style.display = 'none';
  }

  // Ajouter animal
  async function addAnimal() {
    const file = photoInput.files[0];
    const canvasData = canvas.toDataURL('image/png');
    if (!file && (!canvasData || canvasData === 'data:,')) {
      alert('Sélectionnez ou capturez une photo ! 🌿');
      return;
    }

    addBtn.disabled = true;
    status.style.display = 'flex';

    if (file) {
      if (!file.type.startsWith('image/')) {
        alert('Veuillez sélectionner une image valide (JPG, PNG, etc.).');
        addBtn.disabled = false;
        status.style.display = 'none';
        return;
      }
      let reader = new FileReader();
      reader.onload = (e) => processImage(e.target.result);
      reader.onerror = () => {
        alert('Erreur lors de la lecture de l\'image.');
        addBtn.disabled = false;
        status.style.display = 'none';
      };
      reader.readAsDataURL(file);
    } else {
      processImage(canvasData);
    }
  }

  // Analyse IA et ajout
  async function processImage(imageSrc) {
    const img = new Image();
    img.src = imageSrc;
    img.onload = async () => {
      try {
        const predictions = await model.classify(img, 3); // Obtenir les 3 meilleures prédictions
        let detectedName = 'Créature Mystérieuse';
        let confidence = 0;
        let animalType = 'Inconnu';

        if (predictions.length > 0) {
          const topPred = predictions[0];
          confidence = Math.round(topPred.probability * 100);
          const rawName = topPred.className.split(',')[0].trim().toLowerCase();
          detectedName = translations[rawName] || rawName.charAt(0).toUpperCase() + rawName.slice(1);
          animalType = getAnimalType(rawName);

          // Si la confiance est faible, proposer les 3 meilleures prédictions
          if (confidence < 70) {
            const options = predictions.map(p => `${translations[p.className.split(',')[0].trim().toLowerCase()] || p.className} (${Math.round(p.probability * 100)}%)`).join(', ');
            alert(`Confiance faible. Suggestions : ${options}`);
          }
        }

        nameInput.value = detectedName ? `${detectedName} (${confidence}%)` : 'Créature Mystérieuse';

        const animal = {
          id: Date.now(),
          name: nameInput.value || detectedName,
          image: imageSrc,
          confidence: confidence,
          type: animalType
        };
        animalDex.unshift(animal);
        saveToLocalStorage();
        renderDex(true); // Animation pour nouvelle carte
        photoInput.value = '';
        nameInput.value = '';
        addBtn.disabled = false;
        status.style.display = 'none';
      } catch (error) {
        console.error('Erreur lors de l\'analyse de l\'image:', error);
        alert('Erreur lors de l\'analyse de l\'image. Réessayez.');
        addBtn.disabled = false;
        status.style.display = 'none';
      }
    };
    img.onerror = () => {
      alert('Erreur lors du chargement de l\'image. Vérifiez le format ou réessayez.');
      addBtn.disabled = false;
      status.style.display = 'none';
    };
  }

  function getAnimalType(className) {
    const animalTypes = {
      'cat': 'Mammifère', 'dog': 'Mammifère', 'horse': 'Mammifère', 'cow': 'Mammifère',
      'elephant': 'Mammifère', 'bear': 'Mammifère', 'zebra': 'Mammifère', 'giraffe': 'Mammifère',
      'sheep': 'Mammifère', 'tiger': 'Mammifère', 'lion': 'Mammifère', 'wolf': 'Mammifère',
      'fox': 'Mammifère', 'deer': 'Mammifère', 'rabbit': 'Mammifère', 'monkey': 'Mammifère',
      'panda': 'Mammifère', 'kangaroo': 'Mammifère', 'dolphin': 'Mammifère', 'whale': 'Mammifère',
      'bird': 'Oiseau', 'parrot': 'Oiseau', 'eagle': 'Oiseau', 'owl': 'Oiseau', 'penguin': 'Oiseau',
      'fish': 'Poisson', 'shark': 'Poisson', 'turtle': 'Reptile', 'snake': 'Reptile',
      'crocodile': 'Reptile', 'insect': 'Insecte', 'butterfly': 'Insecte', 'spider': 'Arachnide',
      'frog': 'Amphibien', 'lizard': 'Reptile', 'bat': 'Mammifère', 'squirrel': 'Mammifère'
    };
    return animalTypes[className.toLowerCase()] || 'Créature';
  }

  function renderDex(isNew = false) {
    const grid = document.getElementById('dexGrid');
    grid.innerHTML = '';
    animalDex.forEach((animal, index) => {
      const card = document.createElement('div');
      card.className = 'animal-card';
      if (isNew && index === 0) {
        card.classList.add('new');
      }
      card.innerHTML = `
                    <img src="${animal.image}" alt="${animal.name}" loading="lazy">
                    <div class="animal-info">
                        <h3 class="animal-name"><i class="fas fa-paw"></i> ${animal.name}</h3>
                        <p class="confidence">Confiance IA: ${animal.confidence}%</p>
                        <span class="type">${animal.type}</span>
                        <p style="color: #4a6b2a; font-size: 0.9em; margin-top: 8px;">🌿 Observé le ${new Date(animal.id).toLocaleDateString('fr-FR')}</p>
                        <button class="delete-btn" onclick="deleteAnimal(${index})" aria-label="Supprimer ${animal.name}"><i class="fas fa-trash"></i> Supprimer</button>
                    </div>
                `;
      grid.appendChild(card);
    });
  }

  function deleteAnimal(index) {
    animalDex.splice(index, 1);
    saveToLocalStorage();
    renderDex();
  }

  function clearDex() {
    if (confirm('Vider tout le Dex ?')) {
      animalDex = [];
      saveToLocalStorage();
      renderDex();
    }
  }

  function saveToLocalStorage() {
    try {
      localStorage.setItem('animalDex', JSON.stringify(animalDex));
    } catch (error) {
      console.error('Erreur lors de la sauvegarde dans localStorage:', error);
      alert('Impossible de sauvegarder les données. Vérifiez si le stockage local est disponible.');
    }
  }

  function loadFromLocalStorage() {
    try {
      const saved = localStorage.getItem('animalDex');
      if (saved) {
        animalDex = JSON.parse(saved);
      } else {
        animalDex = [];
        saveToLocalStorage();
      }
      renderDex();
    } catch (error) {
      console.error('Erreur lors du chargement depuis localStorage:', error);
      animalDex = [];
      renderDex();
    }
  }

  // Écouteur pour activer le bouton d'ajout dès qu'une image est sélectionnée ou capturée
  photoInput.addEventListener('change', () => {
    if (photoInput.files[0]) {
      addBtn.disabled = false;
    }
  });

  video.addEventListener('loadeddata', () => {
    if (video.videoWidth && video.videoHeight) {
      addBtn.disabled = false;
    }
  });

  loadModel();
  loadFromLocalStorage();
</script>
</body>
</html>
